<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Delhi Pollution Monitor ‚Äî Full Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf (spatial operations) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- toGeoJSON (KML -> GeoJSON) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family: "Trebuchet MS", Helvetica, sans-serif; }
    #map { height:100vh; width:100vw; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.06); color: #fff; }
    .spinner { border: 3px solid rgba(255,255,255,0.12); border-top: 3px solid rgba(255,255,255,0.95); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .leaflet-tooltip.my-tooltip { background: rgba(0,0,0,0.7); border-radius: 6px; color: #fff; padding: 6px 8px; border: 0; font-size: 13px; }
    #liveAQStatusBar { position: absolute; left: 1rem; bottom: 1rem; z-index: 2100; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 13px; }

    /* --- ADDED OPENING TAG BELOW --- */
    /* Removed Neon, replaced with clean typography */
    .neon-text { 
      text-shadow: none; 
      color: #f8fafc;
      letter-spacing: -0.02em;
    }

    .tab-btn-active { background: rgba(52, 211, 153, 0.15); border-bottom: 2px solid #34d399; color: #34d399; }
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn:hover { background: rgba(255,255,255,0.05); }

    /* üåø Professional Action Buttons */
    .ui-tab-btn {
      background: rgba(255, 255, 255, 0.03);
      color: #cbd5e1;
      padding: 12px;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .ui-tab-btn:hover {
      background: rgba(52, 211, 153, 0.1);
      color: #34d399;
      border-color: rgba(52, 211, 153, 0.4);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- Back to Landing -->
  <button onclick="window.location.href='index.html'" class="absolute top-6 left-6 z-[1400] px-4 py-2 rounded-full border border-white/30 hover:bg-white hover:text-black transition">
    ‚Üê Back to Home
  </button>
<style>
    /* ... your existing styles ... */

    /* üü¢ PASTE THIS INSIDE THE <style> TAG */
    
    /* Custom Blinking Glow Animation */
    @keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .live-indicator {
        background-color: #ef4444; /* Tailwind red-500 */
        border-radius: 50%;
        animation: pulse-red 2s infinite;
    }

    /* Smooth Needle Movement */
    #aqiNeedle {
        transform: translateX(-50%);
        transition: left 1s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
    }

    #bigAQI {
        transition: color 0.5s ease;
    }
</style>

<div id="leftWrapper" class="fixed left-6 top-1/2 -translate-y-1/2 z-[1500] flex flex-col gap-4">
    <div id="leftStatsPanel" class="w-80 glass p-7 rounded-3xl border-none shadow-2xl">
        <div class="flex items-center gap-3 mb-3">
            <span id="liveDot" class="w-3 h-3 live-indicator"></span>
            <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-gray-400">Live Delhi Avg</span>
        </div>

        <div class="flex items-baseline gap-3 mb-2">
            <h1 id="bigAQI" class="text-7xl font-black leading-none tracking-tighter">---</h1>
            <span class="text-[10px] text-gray-500 font-bold uppercase">AQI (US)</span>
        </div>

        <div id="statusBadge" class="inline-block px-4 py-1.5 rounded-lg text-lg font-bold mb-8 transition-colors duration-500">
            ---
        </div>

        <div class="space-y-5 mb-8 border-t border-white/5 pt-6">
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-1">PM10 Particle</p>
                    <p class="text-2xl font-medium text-slate-200"><span id="val-pm10">---</span></p>
                </div>
                <span class="text-[10px] text-gray-600 font-bold mb-1">¬µg/m¬≥</span>
            </div>
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-1">PM2.5 Particle</p>
                    <p class="text-2xl font-medium text-slate-200"><span id="val-pm25">---</span></p>
                </div>
                <span class="text-[10px] text-gray-600 font-bold mb-1">¬µg/m¬≥</span>
            </div>
        </div>

        <div class="relative w-full pb-2">
            <div class="h-1.5 w-full rounded-full flex overflow-hidden bg-white/10">
                <div class="h-full bg-emerald-500" style="width: 10%"></div> <div class="h-full bg-yellow-400" style="width: 10%"></div> <div class="h-full bg-orange-500" style="width: 20%"></div> <div class="h-full bg-red-500" style="width: 20%"></div>    <div class="h-full bg-purple-600" style="width: 20%"></div> <div class="h-full bg-rose-900" style="width: 20%"></div>   </div>
            <div id="aqiNeedle" class="absolute top-[-3px] w-3 h-3 bg-white rounded-full border-2 border-black shadow-[0_0_10px_white]" style="left: 0%;"></div>
        </div>
    </div>
</div>
  <!-- Search bar -->
  <div class="absolute top-6 left-1/2 -translate-x-1/2 z-[1400] w-[92%] max-w-xl">
    <div class="relative">
      <input id="searchInput" type="text" placeholder="Search ward / locality (Enter) ‚Äî e.g. Rohini, Connaught Place, IGI Airport" class="w-full px-5 py-3 rounded-full glass placeholder-gray-300 focus:outline-none pr-28 text-sm" />
      <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 rounded-full bg-white/8 hover:bg-white/12 text-sm">Search</button>
    </div>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Loading overlay -->
  <div id="loadOverlay" style="display:none;position:absolute; inset:0; z-index:2000; align-items:center; justify-content:center; pointer-events:none;">
    <div class="glass flex items-center gap-3 p-3 pointer-events-auto">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadText" class="text-sm">Loading...</div>
    </div>
  </div>

  <!-- Info side panel (glassmorphism) -->
<div id="infoPanel" class="fixed top-0 right-0 h-full w-[92%] max-w-sm glass p-6 translate-x-full transition-transform duration-500 z-[2000] overflow-auto">
  <!-- üîπ Original Working Elements -->
  <h2 id="locationTitle" class="text-3xl font-semibold mb-1 neon-text">Location</h2>
  <p id="locationSub" class="text-xs text-gray-300 mb-4">--</p>

  <p id="aqiText" class="text-4xl font-black mb-4">AQI: --</p>

  <div class="grid grid-cols-2 gap-4 text-sm mb-6">
    <div class="glass p-3 rounded-lg text-center">
      PM‚ÇÇ.‚ÇÖ <br><span id="pm25" class="text-xl font-semibold">--</span>
    </div>
    <div class="glass p-3 rounded-lg text-center">
      PM‚ÇÅ‚ÇÄ <br><span id="pm10" class="text-xl font-semibold">--</span>
    </div>
  </div>


  
  <!-- üåü Unified Tab Section (Govt + Citizen UI) -->
  <div id="uiTabs" class="grid grid-cols-2 gap-3 mb-6">

  <!-- üîπ Govt / Ward Analysis Tabs -->
    <button class="ui-tab-btn" data-key="staySafe">Health Advisory</button>
    <button class="ui-tab-btn" data-key="forecast">AQI Forecast</button>
    <button class="ui-tab-btn" data-key="actions">Directives</button>

    <!-- üßë‚Äçü§ù‚Äçüßë Citizen-Exclusive Features -->
    <button class="ui-tab-btn" data-key="complaint">Grievances</button>
    <button class="ui-tab-btn" data-key="policies">Policy (GRAP)</button>
    <button class="ui-tab-btn" data-key="govTask">MCD Actions</button>

  </div>
  <div class="mt-4">
    <h3 class="font-semibold mb-2">AQI Trend (24h)</h3>
    <div id="aqiTrendContainer" class="glass rounded-lg p-3">
      <svg id="historyGraph" width="100%" height="180"></svg>
    </div>
    <div id="ciggsEqBelow" class="text-xs text-gray-300 mt-2"></div>
  </div>

  <!-- üîπ Mandatory advisory for JS -->
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Health Advisory</h3>
    <p id="advisory" class="text-gray-200 text-sm">--</p>
  </div>
  <div id="sourceBreakdown" class="mt-6 hidden">
    <h3 class="font-semibold mb-3 text-emerald-400">üî¨ Pollution Sources</h3>
    <div id="sourceList" class="space-y-2"></div>
  </div>

  <!-- üîπ Close Button -->
  <div class="mt-6">
    <button id="closePanel" class="mt-4 w-full px-4 py-2 rounded-full bg-white/8 hover:bg-white/12 text-sm">
      Close
    </button>
  </div>
</div>
<!-- üí¨ FLOATING POPUP PANEL INSIDE MAP -->
<div id="citizenFloat"
  class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[70vw] max-w-[1400px] min-h-[65vh]
         bg-black/95 glass p-10 rounded-2xl shadow-[0_30px_120px_rgba(16,185,129,0.15)] backdrop-blur-xl
         border border-emerald-500/25 z-[4000] transition-all duration-500 ease-out
         opacity-0 scale-95 flex flex-col">

  <button id="citizenFloatClose"
    class="absolute top-3 right-3 text-gray-300 hover:text-white text-lg">‚úñ</button>

  <h2 id="citizenFloatTitle" class="text-3xl font-bold text-emerald-400 mb-6 tracking-wide drop-shadow-sm"></h2>

  <div id="citizenFloatBody"
       class="text-base leading-relaxed pr-2 overflow-y-auto overflow-x-hidden break-words flex-1"
       style="max-height: 70vh;">
  </div>
</div>


  <!-- live status badge -->
  <div id="liveAQStatusBar">AQI: ‚Äî</div>



<script>
/* ================== FULL DASHBOARD SCRIPT WITH SPATIAL INTERPOLATION ================== */


const map = L.map('map', { 
    preferCanvas: true,
    zoomControl: false, 
    // Smoothness Settings
    zoomAnimation: true,
    zoomAnimationThreshold: 10,
    // Speed Settings
    zoomSnap: 0,                // Set to 0 for maximum fluid responsiveness
    wheelPxPerZoomLevel: 10,    // Lower = Faster zoom (was 120)
    wheelDelta: 1.5,            // Higher = more zoom per scroll click
    inertia: true,
    inertiaDeceleration: 3000   // Makes movement stop faster
}).setView([28.6139, 77.2090], 11);

// Basemap
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CARTO'
}).addTo(map);

// UI Elements
const loadOverlay = document.getElementById('loadOverlay');
const loadText = document.getElementById('loadText');
const infoPanel = document.getElementById('infoPanel');
const locationTitle = document.getElementById('locationTitle');
const locationSub = document.getElementById('locationSub');
const aqiText = document.getElementById('aqiText');
const pm25El = document.getElementById('pm25');
const pm10El = document.getElementById('pm10');
const advisoryEl = document.getElementById('advisory');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const liveAQStatusBar = document.getElementById('liveAQStatusBar');

function showLoader(msg) {
  loadText.innerText = msg || 'Loading...';
  loadOverlay.style.display = 'flex';
}
function hideLoader() {
  loadOverlay.style.display = 'none';
}

// State variables
let wardsGeo = null;
let wardsLayer = null;
let selectedHighlight = null;
let tempSearchMarker = null;
let aqiStations = [];
let latestWardAQI = null; 
let latestWardAI = null;
const stationLayer = L.layerGroup().addTo(map);


function pointInsideFeature(pt, feature) {
  try {
    if (feature.geometry.type === 'Polygon') {
      return turf.booleanPointInPolygon(pt, feature);
    }
    if (feature.geometry.type === 'MultiPolygon') {
      return feature.geometry.coordinates.some(coords => {
        const poly = turf.polygon(coords);
        return turf.booleanPointInPolygon(pt, poly);
      });
    }
  } catch (e) {}
  return false;
}

// Breakpoints for PM2.5 -> AQI
const PM25_BREAKPOINTS = [
  { bpLow: 0, bpHigh: 30, aqiLow: 0, aqiHigh: 50 },
  { bpLow: 31, bpHigh: 60, aqiLow: 51, aqiHigh: 100 },
  { bpLow: 61, bpHigh: 90, aqiLow: 101, aqiHigh: 200 },
  { bpLow: 91, bpHigh: 120, aqiLow: 201, aqiHigh: 300 },
  { bpLow: 121, bpHigh: 250, aqiLow: 301, aqiHigh: 400 },
  { bpLow: 251, bpHigh: 500, aqiLow: 401, aqiHigh: 500 },
];

function pm25ToAQI(pm25) {
  if (pm25 == null || isNaN(pm25)) return null;
  const c = Math.max(0, Number(pm25));
  let bp = PM25_BREAKPOINTS.find(b => c >= b.bpLow && c <= b.bpHigh) || PM25_BREAKPOINTS[PM25_BREAKPOINTS.length - 1];
  const { aqiLow: Ilo, aqiHigh: Ihi, bpLow: BPLo, bpHigh: BPhi } = bp;
  const I = ((Ihi - Ilo) / (BPhi - BPLo)) * (c - BPLo) + Ilo;
  return Math.round(I);
}

function clampAQI(aqi) {
  if (aqi == null || isNaN(aqi)) return null;
  const v = Number(aqi);
  return Math.min(Math.max(Math.round(v), 0), 500);
}

function getAQIColor(aqi) {
  if (aqi == null) return '#374151';
  if (aqi <= 50) return '#16a34a';
  if (aqi <= 100) return '#eab308';
  if (aqi <= 200) return '#f97316';
  if (aqi <= 300) return '#ef4444';
  if (aqi <= 400) return '#7c2d12';
  return '#5b0219';
}

function getAQILabel(aqi) {
  if (aqi == null) return 'No data';
  if (aqi > 400) return 'Severe';
  if (aqi > 300) return 'Very Poor';
  if (aqi > 200) return 'Poor';
  if (aqi > 100) return 'Moderate';
  if (aqi > 50) return 'Satisfactory';
  return 'Good';
}

function advisoryForAQI(aqi) {
  if (aqi == null) return 'No AQI data available.';
  const note = 'Note: Vulnerable populations include children (especially under 5 years), elderly people, pregnant women, and those with pre-existing respiratory, cardiovascular, or cerebrovascular conditions.';
  switch (true) {
    case aqi <= 50:
      return 'Low risk to health\nNo special precautions needed for anyone\nAll outdoor activities can be done normally';
    case aqi <= 100:
      return 'Minor breathing discomfort may occur in vulnerable populations\nGeneral population requires no special precautions\nVulnerable groups should do less prolonged or strenuous outdoor physical exertion\n' + note;
    case aqi <= 200:
      return 'Breathing or health-related discomfort may occur in vulnerable populations\nGeneral population should do less prolonged or strenuous outdoor physical exertion\nVulnerable groups should avoid prolonged or strenuous outdoor physical exertion\n' + note;
    case aqi <= 300:
      return 'Healthy people may experience breathing discomfort on prolonged exposure\nVulnerable populations experience breathing or health discomfort on short exposure\nGeneral population should avoid outdoor physical exertion\nVulnerable groups must avoid outdoor physical activities completely\n' + note;
    case aqi <= 400:
      return 'Healthy people develop respiratory illness on prolonged exposure\nVulnerable populations experience pronounced respiratory or other illnesses on short exposure\nGeneral population should avoid outdoor physical activities, especially during morning and late evening hours\nVulnerable groups must remain indoors and keep activity levels low\n' + note;
    default:
      return 'Healthy people develop respiratory illness even on prolonged exposure\nVulnerable populations experience serious respiratory or other illnesses on short exposure\nGeneral population should avoid outdoor physical activities completely\nVulnerable groups must remain indoors and keep activity levels low at all times\n' + note;
  }
}

/* ================== CORE SPATIAL ENGINE (NEW) ================== */

function getInterpolatedAQI(lat, lon, stations) {
  if (!stations || stations.length === 0) return null;

  const stationData = stations.map(s => {
    const d = turf.distance(turf.point([lon, lat]), turf.point([s.lon, s.lat]), { units: 'kilometers' });
    const val = s.aqi ?? (s.pm25 ? pm25ToAQI(s.pm25) : null);
    return { val, dist: d };
  }).filter(s => s.val !== null);

  if (stationData.length === 0) return null;
  stationData.sort((a, b) => a.dist - b.dist);

  // If station is right there, use it
  if (stationData[0].dist < 0.5) return { aqi: Math.round(stationData[0].val), method: 'Direct Reading' };

  // IDW Logic (Inverse Distance Weighting)
  const nearest = stationData.slice(0, 3);
  let sumWeight = 0, sumWeightedAQI = 0;

  nearest.forEach(s => {
    const weight = 1 / Math.pow(s.dist, 2);
    sumWeight += weight;
    sumWeightedAQI += s.val * weight;
  });

  return { 
    aqi: clampAQI(sumWeightedAQI / sumWeight), 
    method: 'Spatial Interpolation' 
  };
}

/* ================== BACKEND & DATA PROCESSING ================== */

// Define this globally if you haven't already
const REMOTE_SERVER_URL = 'https://vito-glabellar-semijudicially.ngrok-free.dev';
const LOCAL_BACKEND_URL = 'http://localhost:3000';

async function fetchAQIFromBackend() {
  // 1. Prepare clean base URLs
  const remoteBase = REMOTE_SERVER_URL.replace(/\/$/, ''); // Remove trailing slash
  
  // 2. Define all possible places your API might be running
  // Order matters: Try local first (faster), then remote.
  const endpoints = [
    '/api/aqi',                           // Relative path (if serving from same origin)
    'http://localhost:3000/api/aqi',      // Local development
    `${remoteBase}/api/aqi`               // Remote/Ngrok tunnel
  ];

  console.log("Attempting to fetch AQI data...");

  for (const url of endpoints) {
    try {
      // 3. Fetch with the CRITICAL headers included
      const r = await fetch(url, {
        method: 'GET',
        headers: {
          'ngrok-skip-browser-warning': 'true', // <--- KEEPS THIS from your code
          'Content-Type': 'application/json'
        }
      });

      if (r.ok) {
        const data = await r.json();
        console.log(`Connected to: ${url}`);
        return data;
      }
    } catch (err) {
      // Log quietly to avoid console spam, or debug if needed
      // console.warn(`Skipping ${url}:`, err.message);
    }
  }

  throw new Error('All backend endpoints failed to return AQI data.');
}
function normalizeToStationPoints(payload) {
    const points = [];
    const data = Array.isArray(payload) ? payload : [];
    
    data.forEach(item => {
        let lat = item.lat;
        let lon = item.lon;
        if (lat == null || lon == null) return;

        // Convert AQI string to a number
        let aqiVal = item.aqi ? Number(item.aqi) : null;
        
        // üî¥ FIX: If PM values are missing in your JSON, we estimate them
        // This prevents the "0" showing up on your dashboard
        let pm25 = item.pm25 || (aqiVal ? estimatePM25(aqiVal) : null);
        let pm10 = item.pm10 || (aqiVal ? estimatePM10(aqiVal) : null);

        points.push({
            id: item.uid || `${lat},${lon}`,
            lat: Number(lat), 
            lon: Number(lon),
            aqi: aqiVal,
            pm25: pm25,
            pm10: pm10
        });
    });
    return points;
}

// Helper functions to estimate PM if missing
function estimatePM25(aqi) {
    // Basic linear estimation of PM2.5 based on AQI breakpoints
    if (aqi <= 50) return (aqi / 50) * 12;
    if (aqi <= 100) return 12 + ((aqi - 50) / 50) * 23;0
    if (aqi <= 200) return 35 + ((aqi - 100) / 100) * 115;
    return (aqi / 500) * 250; // Rough estimate for high values
}

function estimatePM10(aqi) {
    return estimatePM25(aqi) * 1.6; // Typical PM10 is roughly 1.6x PM2.5 in Delhi
}

function filterStationsInsideDelhi(stations) {
  if (!wardsGeo?.features) return stations;
  return stations.filter(s => {
    const pt = turf.point([s.lon, s.lat]);
    return wardsGeo.features.some(f => pointInsideFeature(pt, f));
  });
}

function renderAQIStationsOnMap(stationPoints) {
  stationLayer.clearLayers();
  stationPoints.forEach(st => {
    const aqi = st.aqi ?? pm25ToAQI(st.pm25);
    if (!aqi) return;
    L.circleMarker([st.lat, st.lon], {
      radius: 6, fillColor: getAQIColor(aqi), color: '#fff', weight: 1, fillOpacity: 0.9
    }).bindPopup(`Station AQI: ${aqi}`).addTo(stationLayer);
  });
}

/* ================== MAIN INTEGRATION ================== */

async function integrateLiveAQIntoWards() {
  if (!wardsGeo) return;
  showLoader('Syncing Delhi Air Quality...');

  try {
    // 1. Fetch Data ONCE
    const payload = await fetchAQIFromBackend();
    const allPoints = normalizeToStationPoints(payload);
    aqiStations = filterStationsInsideDelhi(allPoints);
    renderAQIStationsOnMap(aqiStations);

    // 2. Calculate City Averages (For the initial Left Panel view)
    let sumAQI = 0, sumPM25 = 0, sumPM10 = 0;
    let countAQI = 0, countPM25 = 0, countPM10 = 0;
    
    aqiStations.forEach(s => {
        const a = s.aqi ?? pm25ToAQI(s.pm25);
        if (a) { sumAQI += a; countAQI++; }
        if (s.pm25) { sumPM25 += s.pm25; countPM25++; }
        if (s.pm10) { sumPM10 += s.pm10; countPM10++; }
    });

    const avgAQI = countAQI ? Math.round(sumAQI / countAQI) : 0;
    const avgPM25 = countPM25 ? Math.round(sumPM25 / countPM25) : 0;
    const avgPM10 = countPM10 ? Math.round(sumPM10 / countPM10) : 0;

    // Update Left Panel with City Average immediately
    updateWardUI({ 
        aqi: avgAQI, 
        pm25: avgPM25, 
        pm10: avgPM10 
    });
    
    liveAQStatusBar.innerText = `Live: Delhi Avg AQI ${avgAQI}`;

    // 3. Interpolate and SAVE data into every Ward Polygon
    wardsGeo.features.forEach(f => {
      const centroid = turf.pointOnFeature(f).geometry.coordinates;
      const result = getInterpolatedAQI(centroid[1], centroid[0], aqiStations);
      
      if (result) {
        f.properties.aqi = result.aqi;
        // üü¢ NEW: Save estimated PM values into the feature right now
        f.properties.pm25 = estimatePM25(result.aqi);
        f.properties.pm10 = estimatePM10(result.aqi);
        f.properties._aqi_method = result.method;
      } else {
        f.properties.aqi = clampAQI(avgAQI);
        f.properties.pm25 = avgPM25;
        f.properties.pm10 = avgPM10;
        f.properties._aqi_method = 'City Average';
      }
    });

    // 4. Color the map
    if (wardsLayer) {
      wardsLayer.eachLayer(layer => {
        const a = layer.feature.properties.aqi;
        layer.setStyle({ fillColor: getAQIColor(a), fillOpacity: 0.4 });
      });
    }
    // Render initial trend if available (uses interpolated AQs saved in features)
    if (typeof window.renderHistoryTrend === 'function' && Array.isArray(payload?.history_24h)) {
      window.renderHistoryTrend(payload.history_24h);
    }
    
  } catch (err) {
    console.error(err);
    liveAQStatusBar.innerText = 'Live fetch failed.';
  } finally {
    hideLoader();
  }
}
/* ================== SEARCH & INTERACTION ================== */

/* ================== UPDATED SEARCH & INTERACTION ================== */



  async function onWardSelected(feature, layer) {
    // --- 1. UI HIGHLIGHTING ---
    if (selectedHighlight) map.removeLayer(selectedHighlight);
    selectedHighlight = L.geoJSON(feature, {
        style: { color: '#00eeff', weight: 4, fillOpacity: 0.3 }
    }).addTo(map);

    const bounds = layer ? layer.getBounds() : L.geoJSON(feature).getBounds();
    map.flyToBounds(bounds, { padding: [50, 50], duration: 1 });

    // --- 2. PREPARE LOCAL DATA ---
    const wardId = feature.properties.Ward_No;
    const wardName = feature.properties.WardName || "Unknown Ward";
    
    // Set global AQI immediately for the tabs
    latestWardAQI = feature.properties.aqi || 0;
    latestWardAI = null; // Clear previous ward's AI data

    if (typeof locationTitle !== 'undefined') locationTitle.innerText = wardName;
    if (typeof locationSub !== 'undefined') locationSub.innerText = `Ward Number: ${wardId} | AC: ${feature.properties.AC_Name}`;
    if (typeof infoPanel !== 'undefined') infoPanel.classList.remove('translate-x-full');

    const localData = {
        aqi: latestWardAQI,
        pm25: feature.properties.pm25 || 0,
        pm10: feature.properties.pm10 || 0,
        analysis: null
    };

    // Render immediately
    updateWardUI(localData);

    // --- 3. FETCH & MERGE ---
    if (wardId) {
        try {
            const baseUrl = REMOTE_SERVER_URL.replace(/\/$/, '');
            const response = await fetch(`${baseUrl}/api/ward-analysis/${wardId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });

            const data = await response.json();

  if (data.success) {
                // ‚úÖ CORRECT PLACE TO SAVE DATA GLOBALLY
                latestWardAI = data.analysis; 
                window.latestForecast24h = data.forecast_24h || [];

                const mergedData = {
                    aqi: latestWardAQI, 
                    pm25: data.raw_pollutants?.pm2_5 || localData.pm25,
                    pm10: data.raw_pollutants?.pm10 || localData.pm10,
                    analysis: data.analysis 
                    ,history_24h: data.history_24h || []
                };

                updateWardUI(mergedData);

                if (window.updateCharts && data.history_24h) {
                    window.updateCharts(data.history_24h, data.forecast_24h);
                }
            }
        } catch (err) {
            console.error("Background fetch failed:", err);
        }
    }
}
function updateWardUI(data) {
    // 1. Extract Values
    const aqi = data.aqi || 0;
    const pm25 = data.pm25 || 0;
    const pm10 = data.pm10 || 0;
    const aiAnalysis = data.analysis || null;

    // 2. Visual Colors/Labels
    const color = getAQIColor(aqi);
    const label = getAQILabel(aqi);

    // --- LEFT DASHBOARD UPDATES ---
    const bigAQI = document.getElementById('bigAQI');
    if (bigAQI) {
        bigAQI.innerText = aqi > 0 ? aqi : "---";
        bigAQI.style.color = color;
    }

    const badge = document.getElementById('statusBadge');
    if (badge) {
        badge.innerText = label;
        badge.style.color = color;
        badge.style.backgroundColor = color + '22';
        badge.style.borderColor = color + '44';
    }

    const needle = document.getElementById('aqiNeedle');
    if (needle) {
        const percentage = Math.max(0, Math.min((aqi / 500) * 100, 100));
        needle.style.left = `${percentage}%`;
    }

    // --- RIGHT INFO PANEL UPDATES ---
    // Handle Text elements safely
    if (typeof aqiText !== 'undefined') {
        aqiText.innerText = `AQI: ${aqi > 0 ? aqi : '--'} - ${label}`;
        aqiText.style.color = color;
    }

    // Handle PM Values (Support various ID naming conventions)
    const pm25Val = pm25 > 0 ? Number(pm25).toFixed(1) : '--';
    const pm10Val = pm10 > 0 ? Number(pm10).toFixed(1) : '--';

    const pm25Targets = ['val-pm25', 'pm25', 'pm25El']; // IDs to try
    pm25Targets.forEach(id => {
        const el = document.getElementById(id) || (typeof window[id] !== 'undefined' ? window[id] : null);
        if (el && el instanceof HTMLElement) el.innerText = pm25Val;
    });

    const pm10Targets = ['val-pm10', 'pm10', 'pm10El'];
    pm10Targets.forEach(id => {
        const el = document.getElementById(id) || (typeof window[id] !== 'undefined' ? window[id] : null);
        if (el && el instanceof HTMLElement) el.innerText = pm10Val;
    });

    // --- ADVISORY & CIGARETTES LOGIC ---
    // 1. Identify the container
    const advisoryElement = document.getElementById('advisory') || (typeof advisoryEl !== 'undefined' ? advisoryEl : null);
    const cigDiv = document.getElementById('ciggsEqBelow'); // Cigarettes summary below trend

  if (advisoryElement) {
      if (aiAnalysis && !aiAnalysis.error) {
            // CASE A: BACKEND DATA IS HERE
            const cigarettes = aiAnalysis.cigarettes_count || '0';
            const impact = aiAnalysis.impact_summary || 'Detailed analysis available.';
            
            // Rich HTML Advisory
            advisoryElement.innerHTML = `
                <div class="space-y-2">
                    <p class="font-semibold text-emerald-400">‚ö†Ô∏è Cigarette Equivalent</p>
                    <p class="text-sm">Breathing this air = smoking <strong>${cigarettes}</strong> cigarettes today.</p>
                    <p class="text-xs text-gray-400 mt-2">${impact}</p>
                </div>
            `;
            
            if (cigDiv) cigDiv.innerText = `Air in the selected ward is equivalent to smoking ${cigarettes} cigarettes a day.`;
        } else {
            // CASE B: LOCAL DATA ONLY (Fallback)
            advisoryElement.innerText = advisoryForAQI(aqi);
            
            if (cigDiv) cigDiv.innerText = ""; 
      }
  }
  // Draw 24h history graph if we have AI-backed arrays captured globally
  if (Array.isArray(data.history_24h) && typeof window.renderHistoryTrend === 'function') {
    window.renderHistoryTrend(data.history_24h);
  }
}

// ============ GRAPH RENDERERS ============
// Utility: map AQI to Y (0..500 -> 160..20)
function aqiToY(aqi, h) {
  const minY = 20, maxY = h - 20;
  const v = Math.max(0, Math.min(500, Number(aqi || 0)));
  const pct = v / 500;
  return maxY - pct * (maxY - minY);
}
function hourLabel(ts) {
  try { return new Date(ts * 1000).getHours().toString().padStart(2, '0'); } catch { return '--'; }
}
function renderColoredLine(svgEl, points, w, h) {
  while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);
  const padL = 30, padR = 10;
  const n = points.length;
  if (!n) return;
  const stepX = (w - padL - padR) / Math.max(1, n - 1);
  for (let i = 0; i < n - 1; i++) {
    const p1 = points[i], p2 = points[i + 1];
    const x1 = padL + i * stepX, x2 = padL + (i + 1) * stepX;
    const y1 = aqiToY(p1.aqi, h), y2 = aqiToY(p2.aqi, h);
    const stroke = getAQIColor(Math.round((p1.aqi + p2.aqi) / 2));
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", x2); line.setAttribute("y2", y2);
    line.setAttribute("stroke", stroke);
    line.setAttribute("stroke-width", "3");
    line.setAttribute("stroke-linecap", "round");
    svgEl.appendChild(line);
  }
  // X-axis hour ticks
  for (let i = 0; i < n; i += 6) {
    const x = padL + i * stepX;
    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("x", x);
    t.setAttribute("y", h - 4);
    t.setAttribute("fill", "#9CA3AF");
    t.setAttribute("font-size", "10");
    t.setAttribute("text-anchor", "middle");
    t.textContent = points[i].label || hourLabel(points[i].time || 0);
    svgEl.appendChild(t);
  }
}
window.renderHistoryTrend = function(history24h) {
  try {
    const svg = document.getElementById('historyGraph');
    if (!svg) return;
    const rect = svg.getBoundingClientRect();
    const w = Math.max(400, rect.width || 600);
    const h = Math.max(160, rect.height || 180);
    const pts = history24h.map(x => ({ aqi: Number(x.aqi || 0), time: x.time }));
    renderColoredLine(svg, pts, w, h);
  } catch (e) { /* no-op */ }
};
window.renderForecastTrend = function(forecast24h) {
  try {
    const svg = document.getElementById('forecastGraph');
    if (!svg) return;
    const rect = svg.getBoundingClientRect();
    const w = Math.max(400, rect.width || 600);
    const h = Math.max(160, rect.height || 180);
    const pts = forecast24h.map(x => ({ aqi: Number(x.aqi || 0), time: x.time }));
    renderColoredLine(svg, pts, w, h);
  } catch (e) { /* no-op */ }
};
map.on('click', (e) => {
  const { lat, lng } = e.latlng;
  placeTempMarker([lat, lng], 'Selected Location');
  
  const feat = findWardAtLatLng(lat, lng);
  if (feat) {
    // UPDATED: No need to call fitBounds here anymore, 
    // onWardSelected now handles the smooth flying/zooming.
    const layer = findLayerForFeature(feat);
    onWardSelected(feat, layer);
  } else {
    // Outside ward click - Fly to the point and show IDW data
    map.flyTo([lat, lng], map.getZoom() < 12 ? 13 : map.getZoom(), {
      duration: 0.8
    });

    const res = getInterpolatedAQI(lat, lng, aqiStations);
    locationTitle.innerText = 'Outside Ward Boundary';
    locationSub.innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    const a = res ? res.aqi : null;
    aqiText.innerText = a ? `AQI: ${a} (Interpolated)` : 'AQI: --';
    aqiText.style.color = getAQIColor(a);
    advisoryEl.innerText = advisoryForAQI(a);
    infoPanel.classList.remove('translate-x-full');
  }
});

/* ================== HELPERS & INITIALIZATION ================== */

function findWardAtLatLng(lat, lng) {
  if (!wardsGeo) return null;
  const pt = turf.point([lng, lat]);
  return wardsGeo.features.find(f => pointInsideFeature(pt, f));
}

function findLayerForFeature(feature) {
  if (!wardsLayer) return null;
  let found = null;
  wardsLayer.eachLayer(l => {
    if (JSON.stringify(l.feature.geometry) === JSON.stringify(feature.geometry)) found = l;
  });
  return found;
}

function placeTempMarker(coords, title) {
  if (tempSearchMarker) map.removeLayer(tempSearchMarker);
  tempSearchMarker = L.circleMarker(coords, { radius: 8, color: '#fff', fillColor: '#000', fillOpacity: 0.5 }).addTo(map);
}

async function handleSearch() {
  const q = searchInput.value.trim();
  if (!q) return;
  const ql = q.toLowerCase();
  const local = wardsGeo?.features.find(f => (f.properties.name || '').toLowerCase().includes(ql));
  
  if (local) {
    const layer = findLayerForFeature(local);
    if (layer) map.fitBounds(layer.getBounds());
    onWardSelected(local, null);
  } else {
    showLoader('Searching...');
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Delhi')}`);
    const res = await resp.json();
    hideLoader();
    if (res.length) {
      const { lat, lon } = res[0];
      const plat = parseFloat(lat), plon = parseFloat(lon);
      map.flyTo([plat, plon], 13, {
    animate: true,
    duration: 0.8, // Duration in seconds
    easeLinearity: 0.1
});
      const ward = findWardAtLatLng(plat, plon);
      if (ward) onWardSelected(ward, null);
    }
  }
}

searchInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleSearch());
searchBtn.addEventListener('click', handleSearch);

async function loadWardShapes() {
  const urls = ['delhi_wards.geojson', 'https://raw.githubusercontent.com/HindustanTimesLabs/shapefiles/master/city/delhi/ward/delhi_ward.kml'];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      if (url.endsWith('.kml')) {
        const text = await r.text();
        return toGeoJSON.kml(new DOMParser().parseFromString(text, 'text/xml'));
      }
      return await r.json();
    } catch (e) {}
  }
  return null;
}

function renderWardsGeoJSON(gj) {
  wardsGeo = gj;
  wardsGeo.features.forEach((f, i) => {
    if (!f.properties) f.properties = {};
    f.properties.name = f.properties.name || f.properties.WARD_NAME || `Ward ${i+1}`;
  });

  wardsLayer = L.geoJSON(wardsGeo, {
    style: { color: '#94a3b8', weight: 1, opacity: 0.5, fillColor: '#374151', fillOpacity: 0.1 },
    onEachFeature: (f, l) => {
      l.on('click', (e) => { L.DomEvent.stopPropagation(e); onWardSelected(f, l); });
    }
  }).addTo(map);
}

(async function init() {
  const gj = await loadWardShapes();
  if (gj) {
    renderWardsGeoJSON(gj);
    map.fitBounds(wardsLayer.getBounds());
    await integrateLiveAQIntoWards();
  } else {
    alert('Ward data not found.');
  }
})();

document.getElementById('closePanel').addEventListener('click', () => infoPanel.classList.add('translate-x-full'));

// End of script

/* ================== UI INTERACTION LOGIC ================== */

// 1. Select the Elements
const uiTabBtns = document.querySelectorAll('.ui-tab-btn');
const citizenFloat = document.getElementById('citizenFloat');
const citizenFloatTitle = document.getElementById('citizenFloatTitle');
const citizenFloatBody = document.getElementById('citizenFloatBody');
const citizenFloatClose = document.getElementById('citizenFloatClose');

// 2. Define Content for each button
const tabData = {
  staySafe: {
    title: "Health Advisory",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Primary Recommendation:</strong> Limit outdoor exposure. Susceptible groups (children, elderly, those with respiratory conditions) should remain indoors.</p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Protective Equipment:</strong> N95/N99 respirators are recommended for unavoidable outdoor travel.</li>
          <li><strong class="text-emerald-400">Indoor Air Quality:</strong> Utilize air purification systems where available. Keep ventilation points sealed during peak pollution hours.</li>
          <li><strong class="text-emerald-400">Physical Exertion:</strong> Avoid strenuous activities outdoors to minimize inhalation of particulate matter.</li>
        </ul>
      </div>`
  },
  forecast: {
    title: "AQI Forecast",
    body: `
      <div class="space-y-3 text-slate-300">
        <div class="glass rounded-lg p-3">
          <svg id="forecastGraph" width="100%" height="180"></svg>
        </div>
        <div id="forecastSummary" class="grid grid-cols-2 gap-3">
          <div class="glass rounded-lg p-3">
            <div class="text-sm font-semibold text-emerald-400 mb-1">Minimum AQI</div>
            <div id="minAqiPacket" class="text-black text-sm bg-white rounded px-2 py-1 inline-block"></div>
          </div>
          <div class="glass rounded-lg p-3">
            <div class="text-sm font-semibold text-emerald-400 mb-1">Maximum AQI</div>
            <div id="maxAqiPacket" class="text-black text-sm bg-white rounded px-2 py-1 inline-block"></div>
          </div>
        </div>
      </div>`
  },
  actions: {
    title: "Public Directives",
    body: `
      <div class="space-y-3 text-slate-300">
        <p>Citizens are requested to adhere to the following measures to assist in pollution mitigation:</p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Vehicular:</strong> Utilize public transport or carpooling. Ensure valid PUC certification.</li>
          <li><strong class="text-emerald-400">Dust Control:</strong> Sprinkle water on premises to suppress dust resuspension.</li>
          <li><strong class="text-emerald-400">Waste Management:</strong> Strictly no burning of biomass or solid waste. Report violations immediately.</li>
        </ul>
      </div>`
  },
  complaint: {
    title: "Grievance Redressal",
    body: `
      <div class="space-y-3 text-slate-300">
        <p>Report environmental violations (garbage burning, construction dust, industrial emissions) directly to the Central Control Room.</p>
        <div class="bg-slate-900/50 p-3 rounded border border-emerald-500/30">
          <p><strong class="text-emerald-400">Green Delhi Helpline:</strong> <a href="tel:1800118600" class="text-emerald-300 hover:underline">1800-11-8600</a></p>
          <p class="mt-1"><strong class="text-emerald-400">Web Portal:</strong> <span class="text-slate-300">greendelhi.gov.in</span></p>
        </div>
      </div>`
  },
  policies: {
    title: "Regulatory Measures (GRAP)",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Active Stage: GRAP Stage-IV (Severe+)</strong></p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Transport:</strong> Entry of heavy goods vehicles (except essentials) is prohibited.</li>
          <li><strong class="text-emerald-400">Construction:</strong> Total ban on C&D activities, including linear public projects.</li>
          <li><strong class="text-emerald-400">Institutions:</strong> Schools closed for physical classes (up to Class IX).</li>
          <li><strong class="text-emerald-400">Workforce:</strong> 50% capacity for public/private offices recommended.</li>
        </ul>
      </div>`
  },
  govTask: {
    title: "Municipal Deployment Status",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Real-time Action Report (Daily):</strong></p>
        <div class="grid grid-cols-2 gap-2 text-center">
          <div class="bg-slate-900/50 p-2 rounded border border-emerald-500/30">
            <div class="text-lg font-bold text-emerald-400">450</div>
            <div class="text-xs text-slate-400">Water Sprinklers</div>
          </div>
          <div class="bg-slate-900/50 p-2 rounded border border-emerald-500/30">
            <div class="text-lg font-bold text-emerald-400">12</div>
            <div class="text-xs text-slate-400">Anti-Smog Guns</div>
          </div>
        </div>
        <p class="text-xs text-emerald-500/70 mt-2">Data updated: 08:00 AM IST</p>
      </div>`
  }
};

// 3. Add Click Listeners to Open the Panel
uiTabBtns.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const key = btn.getAttribute('data-key');
    const data = tabData[key];
    let title = data?.title || '';
    let body = data?.body || '';
if (key === 'staySafe') {
      title = 'Health Advisory';
      const a = latestWardAQI;
      const ai = latestWardAI;
      
      // Check if friend's AI data exists to show the cigarette count
      if (ai && !ai.error) {
        body = `
          <div class="space-y-4 text-slate-300">
            <div class="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-xl">
              <p class="text-emerald-400 font-bold mb-1">‚ö†Ô∏è Cigarette Equivalent</p>
              <p class="text-2xl font-bold text-white">Breathing this air is like smoking <strong>${ai.cigarettes_count}</strong> cigarettes today.</p>
            </div>
            <div class="space-y-2">
              <p class="font-semibold text-emerald-400">Health Impact Summary:</p>
              <p class="text-sm leading-relaxed">${ai.impact_summary}</p>
            </div>
          </div>`;
      } else {
        // Fallback to your original logic if AI data isn't loaded yet
        const label = getAQILabel(a);
        const advice = advisoryForAQI(a);
        body = `
          <div class="space-y-3 text-slate-300">
            <p><strong class="text-emerald-400">Status:</strong> ${a != null ? `${a} - ${label}` : 'No data'}</p>
            <p>${advice}</p>
          </div>`;
      }
    } else if (key === 'actions') {
      title = 'Directives & Mitigation';
      const ai = latestWardAI;
      const list = ai?.source_breakdown || [];

      if (list.length) {
        // Use the detailed mitigation directives from the backend
        body = `
          <p class="text-slate-400 mb-4 text-sm">Official directives based on primary pollution sources in this ward:</p>
          ${list.map(src => `
            <div class="glass p-4 rounded-xl mb-3 border border-white/5">
              <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-emerald-400">${src.source}</span>
                <span class="bg-emerald-500/20 px-2 py-1 rounded text-xs text-emerald-300">${src.contribution_percent}% Contribution</span>
              </div>
              <div class="text-sm text-white mb-2"><strong>Directive:</strong> ${src.actionable_mitigation}</div>
              <div class="text-xs text-emerald-500/70 italic">Expected Impact: ${src.impact_if_removed}</div>
            </div>
          `).join('')}`;
      } else {
        body = '<div class="text-slate-300">No specific directives available for this ward yet.</div>';
      }
    }
    else if (key === 'complaint') {
      title = 'Grievance Redressal';
      body = `
        <div class="space-y-3 text-slate-300">
          <form id="grievForm" class="space-y-2">
            <input id="grievText" type="text" class="w-full px-3 py-2 rounded border border-white/20 bg-black/40" placeholder="Describe the non-compliance">
            <input id="grievImage" type="file" accept="image/*" class="w-full text-xs">
            <button id="grievSubmit" type="button" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white">Submit Complaint</button>
          </form>
          <div id="grievStatus" class="text-xs text-slate-400"></div>
          <div class="mt-4">
            <h4 class="font-semibold mb-2 text-emerald-400">Submitted Complaints</h4>
            <div id="grievList" class="space-y-2"></div>
          </div>
        </div>`;
      setTimeout(() => {
        wireGrievanceUI();
      }, 0);
    }

    citizenFloatTitle.innerHTML = title;
    citizenFloatBody.innerHTML = body;
    citizenFloat.classList.remove('hidden');
    setTimeout(() => {
      citizenFloat.classList.remove('opacity-0', 'scale-95');
    }, 10);

    // After opening forecast, render its content using saved latest forecast
    if (key === 'forecast') {
      setTimeout(() => {
        const dataArr = Array.isArray(window.latestForecast24h) ? window.latestForecast24h : [];
        if (typeof window.renderForecastTrend === 'function') {
          window.renderForecastTrend(dataArr);
        }
        if (Array.isArray(dataArr) && dataArr.length) {
          const minObj = dataArr.reduce((m, x) => (x.aqi < m.aqi ? x : m), dataArr[0]);
          const maxObj = dataArr.reduce((m, x) => (x.aqi > m.aqi ? x : m), dataArr[0]);
          const toHour = t => {
            try { return new Date(t * 1000).getHours().toString().padStart(2, '0'); } catch { return '--'; }
          };
          const prevHour = t => {
            try { const h = new Date(t * 1000).getHours(); return ((h + 23) % 24).toString().padStart(2, '0'); } catch { return '--'; }
          };
          const minPacket = document.getElementById('minAqiPacket');
          const maxPacket = document.getElementById('maxAqiPacket');
          if (minPacket && minObj) minPacket.innerText = `${prevHour(minObj.time)} - ${toHour(minObj.time)} (${minObj.aqi})`;
          if (maxPacket && maxObj) maxPacket.innerText = `${prevHour(maxObj.time)} - ${toHour(maxObj.time)} (${maxObj.aqi})`;
        }
      }, 0);
    }
  });
});

// 4. Close Button Logic
citizenFloatClose.addEventListener('click', () => {
  citizenFloat.classList.add('opacity-0', 'scale-95');
  setTimeout(() => {
    citizenFloat.classList.add('hidden');
  }, 500);
});

async function wireGrievanceUI() {
  const textEl = document.getElementById('grievText');
  const imgEl = document.getElementById('grievImage');
  const submitBtn = document.getElementById('grievSubmit');
  const statusEl = document.getElementById('grievStatus');
  const listEl = document.getElementById('grievList');
  const baseUrl = LOCAL_BACKEND_URL.replace(/\/$/, '');

  async function loadComplaints() {
    listEl.innerHTML = 'Loading...';
    try {
      const r = await fetch(`${baseUrl}/api/grievances`);
      const items = r.ok ? await r.json() : [];
      listEl.innerHTML = items.length ? items.map(it => `
        <div class="glass p-3 rounded flex justify-between items-center">
          <div class="text-xs">
            <div class="font-medium">${it.description || 'No description'}</div>
            ${it.image_url ? `<a href="${it.image_url}" target="_blank" class="text-emerald-400 underline">View Image</a>` : ''}
          </div>
          <button data-id="${it.id}" class="delGriev px-3 py-1 text-xs rounded bg-red-600 hover:bg-red-700 text-white">Delete</button>
        </div>
      `).join('') : '<div class="text-xs text-slate-400">No complaints found.</div>';
      listEl.querySelectorAll('.delGriev').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (!id) return;
          btn.disabled = true;
          try {
            const d = await fetch(`${baseUrl}/api/grievances/${id}`, { method: 'DELETE' });
            if (!d.ok) throw new Error('Delete failed');
            await loadComplaints();
          } catch (err) {
            statusEl.innerText = 'Error deleting complaint.';
          } finally {
            btn.disabled = false;
          }
        });
      });
    } catch (err) {
      listEl.innerHTML = '<div class="text-xs text-red-400">Failed to load complaints.</div>';
    }
  }

  submitBtn.addEventListener('click', async () => {
    const desc = (textEl.value || '').trim();
    const file = imgEl.files && imgEl.files[0];
    if (!desc && !file) {
      statusEl.innerText = 'Please provide a description or an image.';
      return;
    }
    const fd = new FormData();
    fd.append('description', desc);
    if (file) fd.append('image', file);
    if (latestWardName) fd.append('ward', latestWardName);
    statusEl.innerText = 'Submitting...';
    try {
      const r = await fetch(`${baseUrl}/api/grievances`, { method: 'POST', body: fd });
      if (!r.ok) throw new Error('Submit failed');
      statusEl.innerText = 'Submitted successfully.';
      textEl.value = '';
      imgEl.value = '';
      await loadComplaints();
    } catch (err) {
      statusEl.innerText = 'Error submitting complaint.';
    }
  });

  loadComplaints();
}
</script>
</body>
</html>
