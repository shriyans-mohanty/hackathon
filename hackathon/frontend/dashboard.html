<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Delhi Pollution Monitor ‚Äî Full Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf (spatial operations) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- toGeoJSON (KML -> GeoJSON) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #map { height:100vh; width:100vw; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.06); color: #fff; }
    .spinner { border: 3px solid rgba(255,255,255,0.12); border-top: 3px solid rgba(255,255,255,0.95); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .leaflet-tooltip.my-tooltip { background: rgba(0,0,0,0.7); border-radius: 6px; color: #fff; padding: 6px 8px; border: 0; font-size: 13px; }
    #liveAQStatusBar { position: absolute; left: 1rem; bottom: 1rem; z-index: 2100; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 10px; border-radius: 8px; font-size: 13px; }

    /* --- ADDED OPENING TAG BELOW --- */
    /* Removed Neon, replaced with clean typography */
    .neon-text { 
      text-shadow: none; 
      color: #f8fafc;
      letter-spacing: -0.02em;
    }

    .tab-btn-active { background: rgba(52, 211, 153, 0.15); border-bottom: 2px solid #34d399; color: #34d399; }
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn:hover { background: rgba(255,255,255,0.05); }

    /* üåø Professional Action Buttons */
    .ui-tab-btn {
      background: rgba(255, 255, 255, 0.03);
      color: #cbd5e1;
      padding: 12px;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .ui-tab-btn:hover {
      background: rgba(52, 211, 153, 0.1);
      color: #34d399;
      border-color: rgba(52, 211, 153, 0.4);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- Back to Landing -->
  <button onclick="window.location.href='index.html'" class="absolute top-6 left-6 z-[1400] px-4 py-2 rounded-full border border-white/30 hover:bg-white hover:text-black transition">
    ‚Üê Back to Home
  </button>

  <!-- Search bar -->
  <div class="absolute top-6 left-1/2 -translate-x-1/2 z-[1400] w-[92%] max-w-xl">
    <div class="relative">
      <input id="searchInput" type="text" placeholder="Search ward / locality (Enter) ‚Äî e.g. Rohini, Connaught Place, IGI Airport" class="w-full px-5 py-3 rounded-full glass placeholder-gray-300 focus:outline-none pr-28 text-sm" />
      <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 rounded-full bg-white/8 hover:bg-white/12 text-sm">Search</button>
    </div>
  </div>

 <!-- Map container -->
  <div id="map"></div>

  <!-- Loading overlay -->
  <div id="loadOverlay" style="display:none;position:absolute; inset:0; z-index:2000; align-items:center; justify-content:center; pointer-events:none;">
    <div class="glass flex items-center gap-3 p-3 pointer-events-auto">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadText" class="text-sm">Loading...</div>
    </div>
  </div>

  <!-- Info side panel (glassmorphism) -->
<div id="infoPanel" class="fixed top-0 right-0 h-full w-[92%] max-w-sm glass p-6 translate-x-full transition-transform duration-500 z-[2000] overflow-auto">
  <!-- üîπ Original Working Elements -->
  <h2 id="locationTitle" class="text-3xl font-semibold mb-1 neon-text">Location</h2>
  <p id="locationSub" class="text-xs text-gray-300 mb-4">--</p>

  <p id="aqiText" class="text-4xl font-black mb-4">AQI: --</p>

  <div class="grid grid-cols-2 gap-4 text-sm mb-6">
    <div class="glass p-3 rounded-lg text-center">
      PM‚ÇÇ.‚ÇÖ <br><span id="pm25" class="text-xl font-semibold">--</span>
    </div>
    <div class="glass p-3 rounded-lg text-center">
      PM‚ÇÅ‚ÇÄ <br><span id="pm10" class="text-xl font-semibold">--</span>
    </div>
  </div>


  
  <!-- üåü Unified Tab Section (Govt + Citizen UI) -->
  <div id="uiTabs" class="grid grid-cols-2 gap-3 mb-6">

  <!-- üîπ Govt / Ward Analysis Tabs -->
    <button class="ui-tab-btn" data-key="staySafe">Health Advisory</button>
    <button class="ui-tab-btn" data-key="forecast">Meteorology</button>
    <button class="ui-tab-btn" data-key="actions">Directives</button>

    <!-- üßë‚Äçü§ù‚Äçüßë Citizen-Exclusive Features -->
    <button class="ui-tab-btn" data-key="complaint">Grievances</button>
    <button class="ui-tab-btn" data-key="policies">Policy (GRAP)</button>
    <button class="ui-tab-btn" data-key="govTask">MCD Actions</button>

  </div>

  <!-- üîπ Mandatory advisory for JS -->
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Health Advisory</h3>
    <p id="advisory" class="text-gray-200 text-sm">--</p>
  </div>

  <!-- üîπ Close Button -->
  <div class="mt-6">
    <button id="closePanel" class="mt-4 w-full px-4 py-2 rounded-full bg-white/8 hover:bg-white/12 text-sm">
      Close
    </button>
  </div>
</div>
<!-- üí¨ FLOATING POPUP PANEL INSIDE MAP -->
<div id="citizenFloat"
  class="hidden fixed top-[20%] right-[350px] w-[600px] min-h-[400px]
         bg-black/95 glass p-8 rounded-xl shadow-[0_0_40px_rgba(16,185,129,0.1)] backdrop-blur-xl
         border border-emerald-500/20 z-[4000] transition-all duration-300
         translate-x-[160%] flex flex-col">

  <button id="citizenFloatClose"
    class="absolute top-3 right-3 text-gray-300 hover:text-white text-lg">‚úñ</button>

  <h2 id="citizenFloatTitle" class="text-2xl font-bold text-emerald-400 mb-4 tracking-wide drop-shadow-sm"></h2>

  <div id="citizenFloatBody"
       class="text-base leading-relaxed pr-4 overflow-y-auto overflow-x-hidden break-words flex-1"
       style="max-height: 320px;">
  </div>
</div>


  <!-- live status badge -->
  <div id="liveAQStatusBar">AQI: ‚Äî</div>

<script>
/* ================== FULL DASHBOARD SCRIPT WITH SPATIAL INTERPOLATION ================== */


const map = L.map('map', { 
    preferCanvas: true,
    zoomControl: false, 
    // Smoothness Settings
    zoomAnimation: true,
    zoomAnimationThreshold: 10,
    // Speed Settings
    zoomSnap: 0,                // Set to 0 for maximum fluid responsiveness
    wheelPxPerZoomLevel: 10,    // Lower = Faster zoom (was 120)
    wheelDelta: 1.5,            // Higher = more zoom per scroll click
    inertia: true,
    inertiaDeceleration: 3000   // Makes movement stop faster
}).setView([28.6139, 77.2090], 11);

// Basemap
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CARTO'
}).addTo(map);

// UI Elements
const loadOverlay = document.getElementById('loadOverlay');
const loadText = document.getElementById('loadText');
const infoPanel = document.getElementById('infoPanel');
const locationTitle = document.getElementById('locationTitle');
const locationSub = document.getElementById('locationSub');
const aqiText = document.getElementById('aqiText');
const pm25El = document.getElementById('pm25');
const pm10El = document.getElementById('pm10');
const advisoryEl = document.getElementById('advisory');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const liveAQStatusBar = document.getElementById('liveAQStatusBar');

function showLoader(msg) {
  loadText.innerText = msg || 'Loading...';
  loadOverlay.style.display = 'flex';
}
function hideLoader() {
  loadOverlay.style.display = 'none';
}

// State variables
let wardsGeo = null;
let wardsLayer = null;
let selectedHighlight = null;
let tempSearchMarker = null;
let aqiStations = [];
const stationLayer = L.layerGroup().addTo(map);

function pointInsideFeature(pt, feature) {
  try {
    if (feature.geometry.type === 'Polygon') {
      return turf.booleanPointInPolygon(pt, feature);
    }
    if (feature.geometry.type === 'MultiPolygon') {
      return feature.geometry.coordinates.some(coords => {
        const poly = turf.polygon(coords);
        return turf.booleanPointInPolygon(pt, poly);
      });
    }
  } catch (e) {}
  return false;
}

// Breakpoints for PM2.5 -> AQI
const PM25_BREAKPOINTS = [
  { bpLow: 0, bpHigh: 30, aqiLow: 0, aqiHigh: 50 },
  { bpLow: 31, bpHigh: 60, aqiLow: 51, aqiHigh: 100 },
  { bpLow: 61, bpHigh: 90, aqiLow: 101, aqiHigh: 200 },
  { bpLow: 91, bpHigh: 120, aqiLow: 201, aqiHigh: 300 },
  { bpLow: 121, bpHigh: 250, aqiLow: 301, aqiHigh: 400 },
  { bpLow: 251, bpHigh: 500, aqiLow: 401, aqiHigh: 500 },
];

function pm25ToAQI(pm25) {
  if (pm25 == null || isNaN(pm25)) return null;
  const c = Math.max(0, Number(pm25));
  let bp = PM25_BREAKPOINTS.find(b => c >= b.bpLow && c <= b.bpHigh) || PM25_BREAKPOINTS[PM25_BREAKPOINTS.length - 1];
  const { aqiLow: Ilo, aqiHigh: Ihi, bpLow: BPLo, bpHigh: BPhi } = bp;
  const I = ((Ihi - Ilo) / (BPhi - BPLo)) * (c - BPLo) + Ilo;
  return Math.round(I);
}

function clampAQI(aqi) {
  if (aqi == null || isNaN(aqi)) return null;
  const v = Number(aqi);
  return Math.min(Math.max(Math.round(v), 0), 500);
}

function getAQIColor(aqi) {
  if (aqi == null) return '#374151';
  if (aqi <= 50) return '#16a34a';
  if (aqi <= 100) return '#eab308';
  if (aqi <= 200) return '#f97316';
  if (aqi <= 300) return '#ef4444';
  if (aqi <= 400) return '#7c2d12';
  return '#5b0219';
}

function getAQILabel(aqi) {
  if (aqi == null) return 'No data';
  if (aqi > 400) return 'Severe';
  if (aqi > 300) return 'Very Poor';
  if (aqi > 200) return 'Poor';
  if (aqi > 100) return 'Moderate';
  if (aqi > 50) return 'Satisfactory';
  return 'Good';
}

function advisoryForAQI(aqi) {
  if (aqi == null) return 'No AQI data available.';
  if (aqi > 200) return 'Avoid outdoor activities. Wear N95 masks if stepping out.';
  if (aqi > 100) return 'Reduce prolonged outdoor exertion.';
  return 'Air quality acceptable for most individuals.';
}

/* ================== CORE SPATIAL ENGINE (NEW) ================== */

function getInterpolatedAQI(lat, lon, stations) {
  if (!stations || stations.length === 0) return null;

  const stationData = stations.map(s => {
    const d = turf.distance(turf.point([lon, lat]), turf.point([s.lon, s.lat]), { units: 'kilometers' });
    const val = s.aqi ?? (s.pm25 ? pm25ToAQI(s.pm25) : null);
    return { val, dist: d };
  }).filter(s => s.val !== null);

  if (stationData.length === 0) return null;
  stationData.sort((a, b) => a.dist - b.dist);

  // If station is right there, use it
  if (stationData[0].dist < 0.5) return { aqi: Math.round(stationData[0].val), method: 'Direct Reading' };

  // IDW Logic (Inverse Distance Weighting)
  const nearest = stationData.slice(0, 3);
  let sumWeight = 0, sumWeightedAQI = 0;

  nearest.forEach(s => {
    const weight = 1 / Math.pow(s.dist, 2);
    sumWeight += weight;
    sumWeightedAQI += s.val * weight;
  });

  return { 
    aqi: clampAQI(sumWeightedAQI / sumWeight), 
    method: 'Spatial Interpolation' 
  };
}

/* ================== BACKEND & DATA PROCESSING ================== */

async function fetchAQIFromBackend() {
  const endpoints = ['/api/aqi', 'http://localhost:3000/api/aqi'];
  for (const url of endpoints) {
    try {
      const r = await fetch(url);
      if (r.ok) return await r.json();
    } catch (err) {}
  }
  throw new Error('All backend endpoints failed');
}

function normalizeToStationPoints(payload) {
  const points = [];
  const data = Array.isArray(payload) ? payload : (payload?.results || (payload?.aqi ? [payload] : []));
  
  data.forEach(item => {
    let lat = item.lat ?? item.latitude ?? item.location?.lat ?? item.coordinates?.latitude ?? item.city?.geo?.[0];
    let lon = item.lon ?? item.longitude ?? item.location?.lon ?? item.coordinates?.longitude ?? item.city?.geo?.[1];
    if (lat == null || lon == null) return;

    let aqiVal = item.aqi ?? item.v;
    let pm25 = item.pm25 ?? item.iaqi?.pm25?.v;
    let pm10 = item.pm10 ?? item.iaqi?.pm10?.v;

    // OpenAQ fallback
    if (item.measurements) {
        item.measurements.forEach(m => {
            if (m.parameter === 'pm25') pm25 = m.value;
            if (m.parameter === 'pm10') pm10 = m.value;
        });
    }

    points.push({
      id: item.uid ?? item.location ?? `${lat},${lon}`,
      lat: Number(lat), lon: Number(lon),
      aqi: (aqiVal === '-' || aqiVal == null) ? null : Number(aqiVal),
      pm25: pm25 ? Number(pm25) : null,
      pm10: pm10 ? Number(pm10) : null
    });
  });
  return points;
}

function filterStationsInsideDelhi(stations) {
  if (!wardsGeo?.features) return stations;
  return stations.filter(s => {
    const pt = turf.point([s.lon, s.lat]);
    return wardsGeo.features.some(f => pointInsideFeature(pt, f));
  });
}

function renderAQIStationsOnMap(stationPoints) {
  stationLayer.clearLayers();
  stationPoints.forEach(st => {
    const aqi = st.aqi ?? pm25ToAQI(st.pm25);
    if (!aqi) return;
    L.circleMarker([st.lat, st.lon], {
      radius: 6, fillColor: getAQIColor(aqi), color: '#fff', weight: 1, fillOpacity: 0.9
    }).bindPopup(`Station AQI: ${aqi}`).addTo(stationLayer);
  });
}

/* ================== MAIN INTEGRATION ================== */

async function integrateLiveAQIntoWards() {
  if (!wardsGeo) return;
  showLoader('Syncing Delhi Air Quality...');

  try {
    const payload = await fetchAQIFromBackend();
    const allPoints = normalizeToStationPoints(payload);
    aqiStations = filterStationsInsideDelhi(allPoints);
    renderAQIStationsOnMap(aqiStations);

    // Calculate city average as final fallback
    const validAQIs = aqiStations.map(s => s.aqi ?? pm25ToAQI(s.pm25)).filter(v => v != null);
    const cityAvg = validAQIs.length ? (validAQIs.reduce((a, b) => a + b, 0) / validAQIs.length) : null;

    wardsGeo.features.forEach(f => {
      const centroid = turf.pointOnFeature(f).geometry.coordinates;
      const result = getInterpolatedAQI(centroid[1], centroid[0], aqiStations);
      
      if (result) {
        f.properties.aqi = result.aqi;
        f.properties._aqi_method = result.method;
      } else {
        f.properties.aqi = clampAQI(cityAvg);
        f.properties._aqi_method = 'City Average';
      }
    });

    if (wardsLayer) {
      wardsLayer.eachLayer(layer => {
        const a = layer.feature.properties.aqi;
        layer.setStyle({ fillColor: getAQIColor(a), fillOpacity: 0.25 });
      });
    }
    
    liveAQStatusBar.innerText = `Updated: ${new Date().toLocaleTimeString()} ‚Ä¢ Coverage: 100% via Interpolation`;
  } catch (err) {
    console.error(err);
    liveAQStatusBar.innerText = 'Live fetch failed. Check backend.';
  } finally {
    hideLoader();
  }
}

/* ================== SEARCH & INTERACTION ================== */

/* ================== UPDATED SEARCH & INTERACTION ================== */


async function onWardSelected(feature, layer) {
    // 1. UI: Highlight the selected ward
    if (selectedHighlight) map.removeLayer(selectedHighlight);
    selectedHighlight = L.geoJSON(feature, { 
        style: { color: '#00eeff', weight: 4, fillOpacity: 0.3 } 
    }).addTo(map);

    // Zoom to the ward
    const bounds = layer ? layer.getBounds() : L.geoJSON(feature).getBounds();
    map.flyToBounds(bounds, { padding: [50, 50], duration: 1 });

    // 2. Extract the Ward Number (This matches your GeoJSON's "Ward_No": 22)
    const wardId = feature.properties.Ward_No; 
    
    // Update Sidebar basics immediately
    locationTitle.innerText = feature.properties.WardName || "Unknown Ward";
    aqiText.innerText = "Analyzing Air Quality...";
    locationSub.innerText = `Ward Number: ${wardId} | AC: ${feature.properties.AC_Name}`;
    infoPanel.classList.remove('translate-x-full'); // Slide in the panel

    if (wardId) {
        try {
            // 3. Call your friend's specific API route
            // Using the 'ngrok-skip-browser-warning' header is essential for ngrok links
            const response = await fetch(`https://vito-glabellar-semijudicially.ngrok-free.dev/api/ward-analysis/${wardId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            
            const data = await response.json();

            if (data.success) {
                // 4. Update the UI with real data from the backend
                updateWardUI(data);
                
                // 5. Update Charts (If you have them)
                if (window.updateCharts && data.history_24h) {
                    window.updateCharts(data.history_24h, data.forecast_24h);
                }
            } else {
                aqiText.innerText = "Data Unavailable";
                console.error("Backend Error:", data.message);
            }
        } catch (err) {
            console.error("Fetch failed:", err);
            aqiText.innerText = "Offline";
        }
    }
}

function updateWardUI(data) {
    const aqi = data.current_aqi;
    const pollutants = data.raw_pollutants;
    const aiAnalysis = data.analysis;

    // Update AQI and Color
    aqiText.innerText = `AQI: ${aqi}`;
    aqiText.style.color = getAQIColor(aqi);
    
    // Update Pollutant numbers
    document.getElementById('pm25-val').innerText = pollutants?.pm2_5?.toFixed(1) || '--';
    document.getElementById('pm10-val').innerText = pollutants?.pm10?.toFixed(1) || '--';
    
    // Update AI Insights (if your UI has these IDs)
    if (aiAnalysis && !aiAnalysis.error) {
        document.getElementById('health-advice').innerText = aiAnalysis.impact_summary;
        document.getElementById('cig-count').innerText = `Equal to smoking ${aiAnalysis.cigarettes_count} cigarettes today.`;
    }
}

// Helper Function: Updates the sidebar text
function updateWardUI(geoProps, backendData) {
  // Priority: 1. Backend Data, 2. GeoJSON Properties, 3. Default Dash
  const aqi = backendData?.aqi || geoProps.aqi;
  const pm25 = backendData?.pm25 || geoProps.pm25 || '--';
  const pm10 = backendData?.pm10 || geoProps.pm10 || '--';
  const advisory = backendData?.advisory || advisoryForAQI(aqi);

  locationSub.innerText = backendData ? `Source: Live Ward Station` : `Source: ${geoProps._aqi_method || 'Calculated'}`;
  aqiText.innerText = aqi ? `AQI: ${aqi} - ${getAQILabel(aqi)}` : 'AQI: --';
  aqiText.style.color = getAQIColor(aqi);
  pm25El.innerText = pm25;
  pm10El.innerText = pm10;
  advisoryEl.innerText = advisory;
}
map.on('click', (e) => {
  const { lat, lng } = e.latlng;
  placeTempMarker([lat, lng], 'Selected Location');
  
  const feat = findWardAtLatLng(lat, lng);
  if (feat) {
    // UPDATED: No need to call fitBounds here anymore, 
    // onWardSelected now handles the smooth flying/zooming.
    const layer = findLayerForFeature(feat);
    onWardSelected(feat, layer);
  } else {
    // Outside ward click - Fly to the point and show IDW data
    map.flyTo([lat, lng], map.getZoom() < 12 ? 13 : map.getZoom(), {
      duration: 0.8
    });

    const res = getInterpolatedAQI(lat, lng, aqiStations);
    locationTitle.innerText = 'Outside Ward Boundary';
    locationSub.innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    const a = res ? res.aqi : null;
    aqiText.innerText = a ? `AQI: ${a} (Interpolated)` : 'AQI: --';
    aqiText.style.color = getAQIColor(a);
    advisoryEl.innerText = advisoryForAQI(a);
    infoPanel.classList.remove('translate-x-full');
  }
});

/* ================== HELPERS & INITIALIZATION ================== */

function findWardAtLatLng(lat, lng) {
  if (!wardsGeo) return null;
  const pt = turf.point([lng, lat]);
  return wardsGeo.features.find(f => pointInsideFeature(pt, f));
}

function findLayerForFeature(feature) {
  if (!wardsLayer) return null;
  let found = null;
  wardsLayer.eachLayer(l => {
    if (JSON.stringify(l.feature.geometry) === JSON.stringify(feature.geometry)) found = l;
  });
  return found;
}

function placeTempMarker(coords, title) {
  if (tempSearchMarker) map.removeLayer(tempSearchMarker);
  tempSearchMarker = L.circleMarker(coords, { radius: 8, color: '#fff', fillColor: '#000', fillOpacity: 0.5 }).addTo(map);
}

async function handleSearch() {
  const q = searchInput.value.trim();
  if (!q) return;
  const ql = q.toLowerCase();
  const local = wardsGeo?.features.find(f => (f.properties.name || '').toLowerCase().includes(ql));
  
  if (local) {
    const layer = findLayerForFeature(local);
    if (layer) map.fitBounds(layer.getBounds());
    onWardSelected(local, null);
  } else {
    showLoader('Searching...');
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Delhi')}`);
    const res = await resp.json();
    hideLoader();
    if (res.length) {
      const { lat, lon } = res[0];
      const plat = parseFloat(lat), plon = parseFloat(lon);
      map.flyTo([plat, plon], 13, {
    animate: true,
    duration: 0.8, // Duration in seconds
    easeLinearity: 0.1
});
      const ward = findWardAtLatLng(plat, plon);
      if (ward) onWardSelected(ward, null);
    }
  }
}

searchInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleSearch());
searchBtn.addEventListener('click', handleSearch);

async function loadWardShapes() {
  const urls = ['delhi_wards.geojson', 'https://raw.githubusercontent.com/HindustanTimesLabs/shapefiles/master/city/delhi/ward/delhi_ward.kml'];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      if (url.endsWith('.kml')) {
        const text = await r.text();
        return toGeoJSON.kml(new DOMParser().parseFromString(text, 'text/xml'));
      }
      return await r.json();
    } catch (e) {}
  }
  return null;
}

function renderWardsGeoJSON(gj) {
  wardsGeo = gj;
  wardsGeo.features.forEach((f, i) => {
    if (!f.properties) f.properties = {};
    f.properties.name = f.properties.name || f.properties.WARD_NAME || `Ward ${i+1}`;
  });

  wardsLayer = L.geoJSON(wardsGeo, {
    style: { color: '#94a3b8', weight: 1, opacity: 0.5, fillColor: '#374151', fillOpacity: 0.1 },
    onEachFeature: (f, l) => {
      l.on('click', (e) => { L.DomEvent.stopPropagation(e); onWardSelected(f, l); });
    }
  }).addTo(map);
}

(async function init() {
  const gj = await loadWardShapes();
  if (gj) {
    renderWardsGeoJSON(gj);
    map.fitBounds(wardsLayer.getBounds());
    await integrateLiveAQIntoWards();
  } else {
    alert('Ward data not found.');
  }
})();

document.getElementById('closePanel').addEventListener('click', () => infoPanel.classList.add('translate-x-full'));

// End of script


/* ================== UI INTERACTION LOGIC ================== */

// 1. Select the Elements
const uiTabBtns = document.querySelectorAll('.ui-tab-btn');
const citizenFloat = document.getElementById('citizenFloat');
const citizenFloatTitle = document.getElementById('citizenFloatTitle');
const citizenFloatBody = document.getElementById('citizenFloatBody');
const citizenFloatClose = document.getElementById('citizenFloatClose');

// 2. Define Content for each button
const tabData = {
  staySafe: {
    title: "Health Advisory",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Primary Recommendation:</strong> Limit outdoor exposure. Susceptible groups (children, elderly, those with respiratory conditions) should remain indoors.</p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Protective Equipment:</strong> N95/N99 respirators are recommended for unavoidable outdoor travel.</li>
          <li><strong class="text-emerald-400">Indoor Air Quality:</strong> Utilize air purification systems where available. Keep ventilation points sealed during peak pollution hours.</li>
          <li><strong class="text-emerald-400">Physical Exertion:</strong> Avoid strenuous activities outdoors to minimize inhalation of particulate matter.</li>
        </ul>
      </div>`
  },
  forecast: {
    title: "Meteorological Outlook",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Status:</strong> Severe Air Quality</p>
        <p class="text-slate-400">Current meteorological conditions indicate low wind speeds hindering pollutant dispersion. The Ventilation Index is likely to remain below 2,500 m¬≤/s for the next 24 hours, suggesting continued accumulation of pollutants.</p>
        <p class="text-xs text-emerald-500/70 mt-2">Source: IMD / IITM Analysis</p>
      </div>`
  },
  actions: {
    title: "Public Directives",
    body: `
      <div class="space-y-3 text-slate-300">
        <p>Citizens are requested to adhere to the following measures to assist in pollution mitigation:</p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Vehicular:</strong> Utilize public transport or carpooling. Ensure valid PUC certification.</li>
          <li><strong class="text-emerald-400">Dust Control:</strong> Sprinkle water on premises to suppress dust resuspension.</li>
          <li><strong class="text-emerald-400">Waste Management:</strong> Strictly no burning of biomass or solid waste. Report violations immediately.</li>
        </ul>
      </div>`
  },
  complaint: {
    title: "Grievance Redressal",
    body: `
      <div class="space-y-3 text-slate-300">
        <p>Report environmental violations (garbage burning, construction dust, industrial emissions) directly to the Central Control Room.</p>
        <div class="bg-slate-900/50 p-3 rounded border border-emerald-500/30">
          <p><strong class="text-emerald-400">Green Delhi Helpline:</strong> <a href="tel:1800118600" class="text-emerald-300 hover:underline">1800-11-8600</a></p>
          <p class="mt-1"><strong class="text-emerald-400">Web Portal:</strong> <span class="text-slate-300">greendelhi.gov.in</span></p>
        </div>
      </div>`
  },
  policies: {
    title: "Regulatory Measures (GRAP)",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Active Stage: GRAP Stage-IV (Severe+)</strong></p>
        <ul class="list-disc pl-5 space-y-1 text-slate-400 marker:text-emerald-500">
          <li><strong class="text-emerald-400">Transport:</strong> Entry of heavy goods vehicles (except essentials) is prohibited.</li>
          <li><strong class="text-emerald-400">Construction:</strong> Total ban on C&D activities, including linear public projects.</li>
          <li><strong class="text-emerald-400">Institutions:</strong> Schools closed for physical classes (up to Class IX).</li>
          <li><strong class="text-emerald-400">Workforce:</strong> 50% capacity for public/private offices recommended.</li>
        </ul>
      </div>`
  },
  govTask: {
    title: "Municipal Deployment Status",
    body: `
      <div class="space-y-3 text-slate-300">
        <p><strong class="text-emerald-400">Real-time Action Report (Daily):</strong></p>
        <div class="grid grid-cols-2 gap-2 text-center">
          <div class="bg-slate-900/50 p-2 rounded border border-emerald-500/30">
            <div class="text-lg font-bold text-emerald-400">450</div>
            <div class="text-xs text-slate-400">Water Sprinklers</div>
          </div>
          <div class="bg-slate-900/50 p-2 rounded border border-emerald-500/30">
            <div class="text-lg font-bold text-emerald-400">12</div>
            <div class="text-xs text-slate-400">Anti-Smog Guns</div>
          </div>
        </div>
        <p class="text-xs text-emerald-500/70 mt-2">Data updated: 08:00 AM IST</p>
      </div>`
  }
};

// 3. Add Click Listeners to Open the Panel
uiTabBtns.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const key = btn.getAttribute('data-key');
    const data = tabData[key];

    if (data) {
      // Set content
      citizenFloatTitle.innerHTML = data.title;
      citizenFloatBody.innerHTML = data.body;

      // Show Panel (Remove hidden, then slide in)
      citizenFloat.classList.remove('hidden');
      
      // Small timeout to allow the browser to process the 'hidden' removal before animating
      setTimeout(() => {
        citizenFloat.classList.remove('translate-x-[160%]');
      }, 10);
    }
  });
});

// 4. Close Button Logic
citizenFloatClose.addEventListener('click', () => {
  // Slide out
  citizenFloat.classList.add('translate-x-[160%]');
  
  // Wait for transition (300ms) then hide
  setTimeout(() => {
    citizenFloat.classList.add('hidden');
  }, 300);
});

</script>
</body>
</html>